

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fire.png">
  <link rel="icon" href="/img/fire.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#6E7783">
  <meta name="author" content="Kk">
  <meta name="keywords" content="pwn">
  
    <meta name="description" content="悟已往之不谏，知来者之可追；实迷途其未远，觉今是而昨非。">
<meta property="og:type" content="article">
<meta property="og:title" content="【kernel 1】kernel pwn入门知识">
<meta property="og:url" content="https://k4n9.cn/2022/12/21/%E3%80%90kernel%201%E3%80%91Kernel%20PWN%E5%85%A5%E9%97%A8%E7%9F%A5%E8%AF%86/index.html">
<meta property="og:site_name" content="k4n9&#39;s blog">
<meta property="og:description" content="悟已往之不谏，知来者之可追；实迷途其未远，觉今是而昨非。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://k4n9.cn/image/haimian.jpg">
<meta property="article:published_time" content="2022-12-21T06:41:05.356Z">
<meta property="article:modified_time" content="2022-12-21T06:46:33.271Z">
<meta property="article:author" content="Kk">
<meta property="article:tag" content="学习">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://k4n9.cn/image/haimian.jpg">
  
  
  
  <title>【kernel 1】kernel pwn入门知识 - k4n9&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"k4n9.cn","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":50,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"90sF1YsG4j1iJ2SCrkV19nPc-gzGzoHsz","app_key":"T7qW6Y3nEJYtpfh2eamEvtHM","server_url":null,"path":"window.location.pathname","ignore_local":true}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>KK的博客</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/image/haimian.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="【kernel 1】kernel pwn入门知识"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-12-21 14:41" pubdate>
          2022年12月21日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          18k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          149 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span>次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">【kernel 1】kernel pwn入门知识</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="零、参考博客"><a href="#零、参考博客" class="headerlink" title="零、参考博客"></a>零、参考博客</h2><p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/258874#h3-14">https://www.anquanke.com/post/id/258874#h3-14</a>  从零开始的 kernel pwn 入门 - I：Linux kernel 简易食用指南</p>
<p><a target="_blank" rel="noopener" href="https://kiprey.github.io/2021/10/kernel_pwn_introduction/#5-kernel-%E7%9A%84-UAF-%E5%88%A9%E7%94%A8">https://kiprey.github.io/2021/10/kernel_pwn_introduction/#5-kernel-%E7%9A%84-UAF-%E5%88%A9%E7%94%A8</a> Kernel pwn CTF 入门</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_54218833/article/details/124360103">https://blog.csdn.net/qq_54218833/article/details/124360103</a> Kernel Pwn 入门 (1)</p>
<h2 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h2><p>​		操作系统刚好上课学到这个地方，不如就顺着这个方向持续性学习内核知识，跟着 <a target="_blank" rel="noopener" href="https://arttnba3.cn/"><strong>arttnba3</strong></a> 师傅学习了一些环境的配置，完成这篇博客如下。</p>
<h2 id="二、环境配置（virtualbox版）"><a href="#二、环境配置（virtualbox版）" class="headerlink" title="二、环境配置（virtualbox版）"></a>二、环境配置（virtualbox版）</h2><h2 id="（一）获取内核镜像（bzImage）"><a href="#（一）获取内核镜像（bzImage）" class="headerlink" title="（一）获取内核镜像（bzImage）"></a>（一）获取内核镜像（bzImage）</h2><p>获取内核镜像是又三种方式的，这里采用的是下载内核源码后编译。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> linux-2.6.32.1/</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get install libncurses5-dev</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get install qemu qemu-system</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">make menuconfig</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">make</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">make all</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">make modules</span><br></code></pre></td></tr></table></figure>

<h2 id="（二）下载busybox"><a href="#（二）下载busybox" class="headerlink" title="（二）下载busybox"></a>（二）下载busybox</h2><p> 下载busybox安装包1.31.0当前最新稳定版本，并解压： </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget  https://busybox.net/downloads/busybox-1.31.0.tar.bz2<br>tar -xjvf busybox-1.31.0.tar.bz2<br></code></pre></td></tr></table></figure>

<p>如果没办法在linux中使用wget下载，那就在windows中下载好了，再传给虚拟机。</p>
<p>如果采用这个方法的话需要配置virtualbox和主机的共享文件夹：</p>
<h3 id="1-设置共享文件夹路径"><a href="#1-设置共享文件夹路径" class="headerlink" title="1.设置共享文件夹路径"></a><strong>1.设置共享文件夹路径</strong></h3><p><img src="C:\Users\KangJing\AppData\Roaming\Typora\typora-user-images\1670806437344.png" srcset="/img/loading.gif" lazyload alt="1670806437344"></p>
<p>勾选自动挂载和固定分配。<strong>该处的共享文件夹名称需要和后来的挂载共享文件夹名称相同</strong>。</p>
<p><strong>安装virtualbox增强工具</strong></p>
<p>不是本篇的核心，比较简单，略过。</p>
<p><strong>挂载共享文件夹</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo mount -t vboxsf 共享文件夹名称（在设置页面设置的） 挂载的目录<br>例如我的命令为:<br>mount -t vboxsf vb_share /home/kang/Desktop/share<br></code></pre></td></tr></table></figure>

<p>这样就可以在桌面有共享文件夹了。</p>
<h2 id="（三）编译和安装busybox"><a href="#（三）编译和安装busybox" class="headerlink" title="（三）编译和安装busybox"></a>（三）编译和安装busybox</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd busybox-1.31.0/ <br>make menuconfig<br></code></pre></td></tr></table></figure>

<p>busybox的配置程序和内核的菜单配置基本上是一模一样的，如果搞通一个，那就可以弄熟悉。</p>
<p>检查以下menuconfig，有以下注意事项：</p>
<ol>
<li>Show verbose <a target="_blank" rel="noopener" href="http://product.it168.com/list/b/03020022_1.shtml">apple</a>t us<a target="_blank" rel="noopener" href="http://product.it168.com/detail/doc/139047/index.shtml">ag</a>e messages<br>Runtime SUID&#x2F;SGID configuration via &#x2F;etc&#x2F;busybox.conf</li>
</ol>
<p>这两个应该选择</p>
<ol start="2">
<li><em>Build Options</em><br><strong>Build BusyBox as a static binary (no shared libs)</strong></li>
</ol>
<p> <strong>这个选项是一定要选择的,这样才能把busybox编译成静态链接的可执行文件,运行时才独立于其他函数库.否则必需要其他库文件才能运行,在单一个linux内核不能使他正常工作.</strong> </p>
<ol start="3">
<li><em>Installation Options</em><br>Don’t use &#x2F;usr</li>
</ol>
<p>这个选项也一定要选,否则make install 后busybox将安装在原系统的&#x2F;usr下,这将覆盖掉系统原有的命令.选择这个选项后,make install后会在busybox目录下生成一个叫_install的目录,里面有busybox和指向他的链接。</p>
<p>其他选项用默认即可。</p>
<p><img src="C:\Users\KangJing\AppData\Roaming\Typora\typora-user-images\1670807087817.png" srcset="/img/loading.gif" lazyload alt="1670807087817"></p>
<p>出现这样的窗口即是成功的。</p>
<p>接着是配置busybox的环境变量：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">vi /etc/profile<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#添加以下内容：</span></span><br>export PATH=/root/busybox-1.31.0/_install/bin:$PATH<br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\KangJing\AppData\Roaming\Typora\typora-user-images\1670807256047.png" srcset="/img/loading.gif" lazyload alt="1670807256047"></p>
<p>使环境变量生效：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">source /etc/profile<br></code></pre></td></tr></table></figure>

<p>然后可以输入以下命令进行测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">busybox ls<br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\KangJing\AppData\Roaming\Typora\typora-user-images\1670807328528.png" srcset="/img/loading.gif" lazyload alt="1670807328528"></p>
<h2 id="（四）配置文件系统和镜像"><a href="#（四）配置文件系统和镜像" class="headerlink" title="（四）配置文件系统和镜像"></a>（四）配置文件系统和镜像</h2><p>编译完成busybox后会生成一个_install目录，接下来用它来构建磁盘镜像。</p>
<h3 id="1-建立文件系统"><a href="#1-建立文件系统" class="headerlink" title="1.建立文件系统"></a><strong>1.建立文件系统</strong></h3><p>在busybox目录下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd _install<br>mkdir -pv &#123;bin,sbin,etc,proc,sys,usr/&#123;bin,sbin&#125;&#125;<br></code></pre></td></tr></table></figure>

<p>在_install中再新增etc，在里面增加inittab文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd etc<br>touch inittab<br>-----------------------This is Content---------------------------<br>::sysinit:/etc/init.d/rcS<br>::askfirst:/bin/ash<br>::ctrlaltdel:/sbin/reboot<br>::shutdown:/sbin/swapoff -a<br>::shutdown:/bin/umount -a -r<br>::restart:/sbin/init<br></code></pre></td></tr></table></figure>

<p>再增加etc&#x2F;init.d&#x2F;rcS文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir init.d<br>cd init.d<br>touch rcS<br>-----------------------This is Content---------------------------<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br>mount -t proc none /proc<br>mount -t sys none /sys<br>/bin/mount -n -t sysfs none /sys<br>/bin/mount -t ramfs none /dev<br>/sbin/mdev -<br></code></pre></td></tr></table></figure>

<h3 id="2-制作img镜像"><a href="#2-制作img镜像" class="headerlink" title="2.制作img镜像"></a>2.制作img镜像</h3><p>在_install目录下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">find . | cpio -o --format=newc &gt; ../rootfs.img<br></code></pre></td></tr></table></figure>

<p>即在busybox里面创建了镜像。</p>
<h3 id="3-启动qemu"><a href="#3-启动qemu" class="headerlink" title="3.启动qemu"></a>3.启动qemu</h3><p>对于我的路径：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">qemu-system-i386 -kernel ./arch/i386/boot/bzImage -initrd ../busybox-1.31.0/rootfs.img -append &quot;root=/dev/ram rdinit=/sbin/init&quot;<br></code></pre></td></tr></table></figure>

<p>根据系统版本使用对应的qemu，一般都是qemu-system-i386</p>
<p><strong>-kernel</strong> 指定内核镜像文件路径：linux&#x2F;arch&#x2F;i386&#x2F;boot&#x2F;bzImage</p>
<p><strong>-initrd</strong> 设置内核启动的文件系统：busybox&#x2F;rootfs.img</p>
<p>qemu可以用的配置：</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br>qemu-system-x86_64 \<br>    -m 64M \<br>    -nographic \<br>    -kernel ./arch/x86/boot/bzImage \<br>    -initrd  ./rootfs.img \<br>    -append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 nokaslr&quot; \<br>    -smp cores=2,threads=1 \<br>    -cpu kvm64<br></code></pre></td></tr></table></figure>
</blockquote>
<p>出现如此窗口成功。</p>
<p><img src="C:\Users\KangJing\AppData\Roaming\Typora\typora-user-images\1670814907269.png" srcset="/img/loading.gif" lazyload alt="1670814907269"></p>
<h2 id="三、配置pwn环境（VMware版）"><a href="#三、配置pwn环境（VMware版）" class="headerlink" title="三、配置pwn环境（VMware版）"></a>三、配置pwn环境（VMware版）</h2><h2 id="（一）编译内核"><a href="#（一）编译内核" class="headerlink" title="（一）编译内核"></a>（一）编译内核</h2><p>首先是常规的将内核编译，这里由于ubuntu是20.04的，所以就选择5.11版本的内核来用于学习。输入以下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.11.tar.xz<br>tar -xvf linux-5.11.tar.xz<br>make menuconfig<br><br></code></pre></td></tr></table></figure>

<p>menuconfig中保证以下是勾选的：</p>
<blockquote>
<ul>
<li>Kernel hacking —&gt; Kernel debugging</li>
<li>Kernel hacking —&gt; Compile-time checks and compiler options —&gt; Compile the kernel with debug info</li>
<li>Kernel hacking —&gt; Generic Kernel Debugging Instruments –&gt; KGDB: kernel debugger</li>
<li>kernel hacking —&gt; Compile the kernel with frame pointers</li>
</ul>
</blockquote>
<p>然后执行make命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">make bzImage<br></code></pre></td></tr></table></figure>

<blockquote>
<p>其中的bzImage是压缩的内核映像。 开头部分内嵌有 gzip解压缩代码，所以不能用gunzip 或 gzip –dc解包vmlinuz。 </p>
</blockquote>
<p>其中编译内核中会出现一些问题，我遇到以下问题：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">make[1]: *** No rule to make target &#x27;debian/canonical-certs.pem&#x27;, needed by &#x27;certs/x509_certificate_list&#x27;.  Stop<br></code></pre></td></tr></table></figure>

<p>该问题需要将<code>.config</code> 文件中找到 <code>CONFIG_SYSTEM_TRUSTED_KEYS</code>，等于号后面的值改为 <code>&quot;&quot;</code> </p>
<p>问题2：</p>
<p><img src="C:\Users\KangJing\AppData\Roaming\Typora\typora-user-images\1670852873988.png" srcset="/img/loading.gif" lazyload alt="1670852873988"></p>
<p>获得内核镜像的其他方式：</p>
<p>下载现有的镜像。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt search linux-image- <span class="hljs-comment">##选择版本</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt download linux-image-5.8.0-43-generic</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">dpkg -X ./linux-image-5.8.0-43-generic_5.8.0-43.49~20.04.1_amd64.deb extract</span><br>./<br>./boot/<br>./boot/vmlinuz-5.8.0-43-generic<br>./usr/<br>./usr/share/<br>./usr/share/doc/<br>./usr/share/doc/linux-image-5.8.0-43-generic/<br>./usr/share/doc/linux-image-5.8.0-43-generic/changelog.Debian.gz<br>./usr/share/doc/linux-image-5.8.0-43-generic/copyright<br><br></code></pre></td></tr></table></figure>

<p>使用本系统的内核镜像。一般位于&#x2F;boot&#x2F;目录下面，可以直接拿出来用。</p>
<h2 id="（二）编译busybox"><a href="#（二）编译busybox" class="headerlink" title="（二）编译busybox"></a>（二）编译busybox</h2><p>首先是获取busybox的源码：</p>
<p>在<a target="_blank" rel="noopener" href="https://busybox.net/downloads/%E4%B8%AD%E5%8F%AF%E4%BB%A5%E4%B8%8B%E8%BD%BD%E5%88%B0%E6%83%B3%E8%A6%81%E7%9A%84busybox%E7%89%88%E6%9C%AC%EF%BC%8C%E7%84%B6%E5%90%8E%EF%BC%9A">https://busybox.net/downloads/中可以下载到想要的busybox版本，然后：</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget https://busybox.net/downloads/busybox-1.33.0.tar.bz2<br>tar -jxvf busybox-1.33.0.tar.bz2<br></code></pre></td></tr></table></figure>

<p>然后进入到busybox的编译：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">make menuconfig<br>勾选Settings —&gt; Build static binary file (no shared lib)<br>要是不勾选的话需要单独配置lib，非常的麻烦。<br>make install<br></code></pre></td></tr></table></figure>

<p>编译完成后会生成一个<code>_install</code>目录，接下来我们将会用它来构建我们的磁盘镜像。</p>
<p>遇到以下问题并解决：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">Example: CONFIG_EXTRA_LDLIBS=&quot;pthread dl tirpc audit pam&quot;<br>Makefile:717: recipe for target &#x27;busybox_unstripped&#x27; failed<br>make: *** [busybox_unstripped] Error 1<br><br>解决方案：make menuconfig<br><br>Linux System Utilities---&gt;nsenter，去掉该选项，重新编译make<br></code></pre></td></tr></table></figure>

<h2 id="（三）建立文件系统"><a href="#（三）建立文件系统" class="headerlink" title="（三）建立文件系统"></a>（三）建立文件系统</h2><p><strong>初始化文件系统：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> _install</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> -pv &#123;bin,sbin,etc,proc,sys,home,lib64,lib/x86_64-linux-gnu,usr/&#123;bin,sbin&#125;&#125;</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">touch</span> etc/inittab</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> etc/init.d</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">touch</span> etc/init.d/rcS</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">chmod</span> +x ./etc/init.d/rcS</span><br></code></pre></td></tr></table></figure>

<p><strong>配置初始化脚本：</strong></p>
<p>首先配置<code>etc/inttab</code>，写入如下内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">::sysinit:/etc/init.d/rcS<br>::askfirst:/bin/ash<br>::ctrlaltdel:/sbin/reboot<br>::shutdown:/sbin/swapoff -a<br>::shutdown:/bin/umount -a -r<br>::restart:/sbin/init<br></code></pre></td></tr></table></figure>

<p>该脚本是系统的初始化脚本，接下来配置<code>etc/init.d/rcS</code>，写入如下内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br>mount -t proc none /proc<br>mount -t sys none /sys<br>/bin/mount -n -t sysfs none /sys<br>/bin/mount -t ramfs none /dev<br>/sbin/mdev -s<br></code></pre></td></tr></table></figure>

<p>配置的是目录的挂载。</p>
<p>配置用户组：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;root:x:0:0:root:/root:/bin/sh&quot;</span> &gt; etc/passwd</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;ctf:x:1000:1000:ctf:/home/ctf:/bin/sh&quot;</span> &gt;&gt; etc/passwd</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;root:x:0:&quot;</span> &gt; etc/group</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;ctf:x:1000:&quot;</span> &gt;&gt; etc/group</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;none /dev/pts devpts gid=5,mode=620 0 0&quot;</span> &gt; etc/fstab</span><br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/38136194">https://zhuanlan.zhihu.com/p/38136194</a> 该知乎讲的是用户和用户组</p>
<p> 在这里建立了两个用户组<code>root</code>和<code>ctf</code>，以及两个用户<code>root</code>和<code>ctf</code> </p>
<p>这个地方还可以配置libc，暂时先忽略。</p>
<h2 id="（四）打包文件系统为镜像文件"><a href="#（四）打包文件系统为镜像文件" class="headerlink" title="（四）打包文件系统为镜像文件"></a>（四）打包文件系统为镜像文件</h2><p>打包文件系统，将镜像文件放入busybox：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">find . | cpio -o --format=newc &gt; ../rootfs.cpio</span><br></code></pre></td></tr></table></figure>

<p>若是还需要向文件系统中补充一些其他文件，比较好的添加办法，是采用解压文件系统镜像后，添加文件再重新打包：</p>
<p><strong>解压磁盘镜像文件：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">cpio -idv &lt; ./rootfs.cpio</span><br></code></pre></td></tr></table></figure>

<p>该命令会将目标目录的磁盘文件所有文件解压到当前目录。</p>
<p>重打包磁盘镜像：</p>
<p>同打包方法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">find . | cpio -o --format=newc &gt; ../rootfs.cpio</span><br></code></pre></td></tr></table></figure>

<h2 id="（五）使用qemu运行内核"><a href="#（五）使用qemu运行内核" class="headerlink" title="（五）使用qemu运行内核"></a>（五）使用qemu运行内核</h2><p><strong>创建启动脚本：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">touch boot.sh<br></code></pre></td></tr></table></figure>

<p>执行以下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br>qemu-system-x86_64 \<br>    -m 128M \<br>    -kernel ./linux-5.11/arch/x86/boot/bzImage \<br>    -initrd  ./busybox-1.33.0/rootfs.cpio \<br>    -monitor /dev/null \<br>    -append &quot;root=/dev/ram rdinit=/sbin/init console=ttyS0 oops=panic panic=1 loglevel=3 quiet nokaslr&quot; \<br>    -cpu kvm64,+smep \<br>    -smp cores=2,threads=1 \<br>    -netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \<br>    -nographic \<br>    -s<br><br></code></pre></td></tr></table></figure>

<p>部分参数说明如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">-m：虚拟机内存大小<br>-kernel：内存镜像路径<br>-initrd：磁盘镜像路径<br>-append：附加参数选项<br>nokalsr：关闭内核地址随机化，方便我们进行调试<br>rdinit：指定初始启动进程，/sbin/init进程会默认以/etc/init.d/rcS作为启动脚本<br>loglevel=3 &amp; quiet：不输出log<br>console=ttyS0：指定终端为/dev/ttyS0，这样一启动就能进入终端界面<br>-monitor：将监视器重定向到主机设备/dev/null，这里重定向至null主要是防止CTF中被人给偷了qemu拿flag<br>-cpu：设置CPU安全选项，在这里开启了smep保护<br>-s：相当于-gdb tcp::1234的简写（也可以直接这么写），后续我们可以通过gdb连接本地端口进行调试<br></code></pre></td></tr></table></figure>

<p>成功启动qemu：</p>
<p><img src="C:\Users\KangJing\AppData\Roaming\Typora\typora-user-images\1670859728779.png" srcset="/img/loading.gif" lazyload alt="1670859728779"></p>
<p>其中有一条报错：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mount: mounting none on /sys failed: No such device<br></code></pre></td></tr></table></figure>

<p>有点找不到问题所在，暂时没有解决。</p>
<h2 id="四、编写可装载内核模块（LKMs）"><a href="#四、编写可装载内核模块（LKMs）" class="headerlink" title="四、编写可装载内核模块（LKMs）"></a>四、编写可装载内核模块（LKMs）</h2><p>这部分的知识已经在上一次内核模块的编写中有了解，这一次就是权当复习。</p>
<h2 id="（一）预备知识及模块编写"><a href="#（一）预备知识及模块编写" class="headerlink" title="（一）预备知识及模块编写"></a>（一）预备知识及模块编写</h2><p>其实LKM也是ELF格式的文件，但是其不能够像普通的ELF一样独立运行，而只能作为内核的一部分存在。</p>
<p>对于LKM而言，其所在的内核空间和用户空间是分开的，对于通常有着SMAP&#x2F;SMEP保护的linux而言，这意味着LKM<strong>并不能使用libc的函数，也不能够直接与用户交互</strong>。</p>
<p>虽然是用C语言编写LKM，但是作为内核的一部分，LKM在一定意义上就是内核编程，内核版本的每次变化意味着某些函数的名称也会发生改变，因此LKM编程与内核版本密切相关。</p>
<p>一些LKM编写的规则和要求如下：</p>
<p><strong>头文件：</strong></p>
<ul>
<li><code>linux/module.h</code>：对于LKM而言这是必须包含的一个头文件</li>
<li><code>linux/kernel.h</code>：载入内核相关信息</li>
<li><code>linux/init.h</code>：包含着一些有用的宏</li>
</ul>
<p> 通常情况下，这三个头文件对于内核模块编程都是不可或缺的。</p>
<p><strong>入口点&#x2F;出口点</strong></p>
<p>一个内核模块的入口点应当为<code> module_init()</code>，出口函数应当为<code>module_exit()</code>，在内核载入&#x2F;卸载内核模块时会缺省调用这两个函数。在这里我们将自定义的两个函数的指针作为参数传入LKM入口函数&#x2F;出口函数中，以作为其入口&#x2F;出口函数。</p>
<p><strong>其他</strong></p>
<ul>
<li><code>__init &amp; __exit</code>：这两个宏用以在函数结束后释放相应的内存</li>
<li><code>MODULE_AUTHOR() &amp; MODULE_LICENSE()</code>：声明内核作者与发行所用许可证</li>
<li><code>printk()</code>：内核态函数，用以在内核缓冲区写入信息，其中<code>&lt;1&gt;</code>标识着信息的紧急级别（一共有8个优先级，0为最高，相关宏定义于linux&#x2F;kernel.h中）</li>
</ul>
<h2 id="（二）编译内核模块"><a href="#（二）编译内核模块" class="headerlink" title="（二）编译内核模块"></a>（二）编译内核模块</h2><p>与一般的可执行文件不同的是，内核模块需要一个makefile进行构建编译：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">obj-m += hellokernel.o<br>CURRENT_PATH := $(shell pwd)<br>LINUX_KERNEL := $(shell uname -r)<br>LINUX_KERNEL_PATH := /usr/src/linux-headers-$(LINUX_KERNEL)<br>all:<br>    make -C $(LINUX_KERNEL_PATH) M=$(CURRENT_PATH) modules<br>clean:<br>    make -C $(LINUX_KERNEL_PATH) M=$(CURRENT_PATH) clean<br></code></pre></td></tr></table></figure>

<ul>
<li><code>obj-m</code>： 指定了编译的结果应当为<code>.ko</code>文件，即可装载内核模块，类似命令有： <code>obj-y</code> 编译进内核 ，<code>obj-n</code> 不编译</li>
<li><code>CURRENT_PATH &amp; LINUX_KERNEL &amp; LINUX_KERNEL_PATH</code>：三个自定义变量，分别意味着通过shell命令获得当前路径、内核版本、内核源码路径</li>
<li><code>all</code>：编译指令</li>
<li><code>clean</code>：清理指令</li>
</ul>
<p>然后执行make即可成功。</p>
<h2 id="五、提供应用式I-x2F-O接口"><a href="#五、提供应用式I-x2F-O接口" class="headerlink" title="五、提供应用式I&#x2F;O接口"></a>五、提供应用式I&#x2F;O接口</h2><p>虽然说模块能够成功在内核运行，但是就没有别的实际作用了，要使得内核模块能够提供更多的功能，并且能和用户进行交互，还需要做更多的工作。</p>
<h2 id="（一）设备注册"><a href="#（一）设备注册" class="headerlink" title="（一）设备注册"></a>（一）设备注册</h2><p>对于linux来说，<strong>万物皆文件</strong>，一切都可以抽象为文件，一切都可以通过访问文件的方式进行操作。这使得高层次上的操作具有一致性，若是想要用户能和内核模块进行交互，则同样需要<strong>通过文件</strong>来运行——注册一个“<strong>虚拟节点</strong>”，随后用户态程序可以使用系统调用 <code>read、write、ioctl</code>来完成与内核模块间的通信。</p>
<p><strong>设备分类</strong></p>
<p>Linux中的I&#x2F;O设备分为如下两类：</p>
<ul>
<li><code>字符设备</code>：在I&#x2F;O传输过程中<strong>以字符为单位</strong>进行传输的设备，例如键盘、串口等。字符设备<strong>按照字符流的方式被有序访问，不能够进行随机读取</strong></li>
<li><code>块设备</code>：在块设备中，信息被存储在固定大小的块中，每个块有着自己的地址，例如硬盘、SD卡等。用户可以对块设备进行<strong>随机访问——从任意位置读取一定长度的数据</strong></li>
</ul>
<p><strong>file_operations结构体</strong></p>
<p>该结构体定义于 <code>include/linux/fs.h</code> ，完成对设备的一些相关定义，其中定义了大量的函数指针。</p>
<p> 一个文件应当拥有一个<code>file_operations实例</code>，并指定<strong>相关系统调用函数指针所指向的自定义函数</strong>，在后续进行设备的注册时会使用该结构体。</p>
<p><strong>主设备号&amp;次设备号</strong></p>
<p>在Linux内核中，使用类型<code>dev_t</code>（unsigned long）来标识一个设备的设备号</p>
<p>设备号为一个字符，由<code>主设备号</code>与<code>次设备号</code>组成，高字节存储主设备号，低字节存储次设备号：</p>
<ul>
<li><code>主设备号</code>：标识设备类型，使用宏<code>MAJOR(dev_t dev)</code>可以获取主设备号</li>
<li><code>次设备号</code>：用以区分同类型设备，使用宏<code>MINOR(dev_t dev)</code>可以获取次设备号</li>
</ul>
<p>Linux还提供了一个宏<code> MKDEV(int major, int minor);</code>，用以通过主次设备号生成对应的设备号。</p>
<p><strong>设备节点</strong></p>
<p>基于万物皆文件，Linux中的所有的设备都以文件的形式进行访问，这些文件都在<code>/dev</code>目录下，</p>
<p><strong>一个文件就是一个设备节点</strong>。</p>
<p>在linux kernel中使用结构体<code>device</code>描述设备，该结构体定义于 <code>include/linux/device.h</code> ，每个设备在内核中都有着对应的device实例，其中记录着设备的信息。在DTS（Device Tree Source 设备树）中则使用<code>device_node</code>结构体表示一个设备。</p>
<p><strong>设备类</strong></p>
<p>在Linux kernel中使用结构体<code>class</code>用以表示<strong>高层次抽象的设备</strong>，该结构体定义于<code>include/linux/device/class.h</code>中，每个设备节点实例中都应当包含着一个指向相应设备类实例的指针。</p>
<p><strong>设备的注册与注销</strong></p>
<p>接下来注册一个<strong>字符设备</strong>，其大致的一个步骤如下：</p>
<ul>
<li>使用由内核提供的函数<code>register_chrdev(unsigned int major, const char *name, const struct file_operations *fops)</code>进行<strong>字符型设备</strong>注册，该函数定义于<code>include/linux/fs.h</code>，会将注册成功后的主设备号返回，若失败则会返回一个负值，参数说明如下：<ul>
<li>major：主设备号，若为0则由内核分配主设备号</li>
<li>name：设备名，由用户指定</li>
<li>fops：该设备的文件操作系统（file_operations结构体）指针</li>
</ul>
</li>
<li>使用宏<code>class_create(owner, name)</code>创建<strong>设备类</strong>，该宏定义于<code>include/linux/device.h</code>中，其核心调用函数是<code>__class_create(struct module *owner, const char *name, struct lock_class_key *key)</code></li>
<li>使用函数<code>device_create(struct class *cls, struct device *parent, dev_t devt, void *drvdata, const char *fmt, ...)</code><strong>创建设备节点</strong>，若成功则最终会在<code>/dev</code>目录下生成我们的设备节点文件，各参数说明如下：<ul>
<li>cls：该设备的设备类</li>
<li>parent：该设备的父设备节点，通常情况下应当为某种总线或主机控制器，若该设备为顶级设备则设为NULL</li>
<li>devt：该设备的设备号</li>
<li>drvdata：该驱动的相关信息，若无则填NULL</li>
<li>fmt：设备名称</li>
</ul>
</li>
</ul>
<p>设备的注销则是逆着上面的进程进行，同样有着相对应的三个函数：<code>device_destroy(struct class *cls, dev_t devt)</code>、<code>class_destroy(struct class *cls)</code>、<code>unregister_chrdev(unsigned int major, const char *name)</code>，用法相似，这里就不一一赘叙了</p>
<p><strong>若是注册设备的进程中某一步出错了，我们在退出内核态函数之前应当手动调用注销函数清理相关的资源。</strong></p>
<p><strong>设备权限</strong></p>
<p>内核模块运行在内核空间，创建的设备节点只有root用户才有权限进行读写，对于其他用户意义不大，还需要进一步进行权限设置，使得<strong>所有用户都有权限</strong>通过设备节点文件与内核模	块进行交互。</p>
<p>在内核中使用<code>inode</code>结构体表示一个文件，该结构体定义于<code>include/linux/fs.h</code>中，其中用以标识权限的是成员<code>i_mode</code>。</p>
<p>而在内核中对于使用<code>flip_open()</code>打开的文件，Linux内核中使用 <code>file</code> 结构体进行描述，该结构体定义于<code>include/linux/fs.h</code>中，其中有着指向内核中该文件的 inode 实例的指针，使用<code>file_inode()</code>函数可以获得一个 file 结构体中的 inode 结构体指针</p>
<p>那么我们不难想到，若是在内核模块中使用<code>file_open()</code>函数打开我们的设备节点文件，随后修改 file 结构体中的 inode 指针指向的 inode 实例的 <strong>i_mode 成员</strong>，便能够修改该文件的权限。</p>
<blockquote>
<p>需要注意的是rwx三个权限位仅占3位，因而应当使用八进制进行操作：<code>__inode-&gt;i_mode |= 0666;</code>，而不是16进制 </p>
</blockquote>
<p>测试代码编写如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/init.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/fs.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/device.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEVICE_NAME <span class="hljs-string">&quot;r1ng&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEVICE_PATH <span class="hljs-string">&quot;/dev/r1ng&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CLASS_NAME <span class="hljs-string">&quot;r1ngmodule&quot;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> major_num;<br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">class</span> * module_class = <span class="hljs-literal">NULL</span>;<span class="hljs-comment">//定义设备类，表示高层次抽象的设备</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">device</span> * module_device = <span class="hljs-literal">NULL</span>;<span class="hljs-comment">//定义设备节点</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">file</span> * __file = <span class="hljs-literal">NULL</span>;<span class="hljs-comment">//对于flip_open打开的文件，都用file结构体进行描述</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">inode</span> * __inode = <span class="hljs-literal">NULL</span>;<span class="hljs-comment">//inode结构体表示一个文件</span><br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">file_operations</span> r1ng_module_fo = <span class="hljs-comment">//系统调用自定义函数</span><br>&#123;<br>    .owner = THIS_MODULE<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title">kernel_module_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printk</span>(KERN_INFO <span class="hljs-string">&quot;[r1ng_TestModule:] Module loaded. Start to register device...\n&quot;</span>);<br>    major_num = <span class="hljs-built_in">register_chrdev</span>(<span class="hljs-number">0</span>, DEVICE_NAME, &amp;r1ng_module_fo);<span class="hljs-comment">//注册字符串设备</span><br>    <span class="hljs-keyword">if</span> (major_num &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printk</span>(KERN_INFO <span class="hljs-string">&quot;[r1ng_TestModule:] Failed to register a major number.\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> major_num;<br>    &#125;    <br>    <span class="hljs-built_in">printk</span>(KERN_INFO <span class="hljs-string">&quot;[r1ng_TestModule:] Register complete, major number: %d\n&quot;</span>, major_num);<span class="hljs-comment">//打印设备号</span><br><br>    module_class = <span class="hljs-built_in">class_create</span>(THIS_MODULE, CLASS_NAME);<span class="hljs-comment">//创建设备类</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IS_ERR</span>(module_class))<br>    &#123;<br>        <span class="hljs-built_in">unregister_chrdev</span>(major_num, DEVICE_NAME);<span class="hljs-comment">//注销字符串设备</span><br>        <span class="hljs-built_in">printk</span>(KERN_INFO <span class="hljs-string">&quot;[r1ng_TestModule:] Failed to register class device!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">PTR_ERR</span>(module_class);<br>    &#125;<br>    <span class="hljs-built_in">printk</span>(KERN_INFO <span class="hljs-string">&quot;[r1ng_TestModule:] Class device register complete.\n&quot;</span>);<br><br>    module_device = <span class="hljs-built_in">device_create</span>(module_class, <span class="hljs-literal">NULL</span>, <span class="hljs-built_in">MKDEV</span>(major_num, <span class="hljs-number">0</span>), <span class="hljs-literal">NULL</span>, DEVICE_NAME);<span class="hljs-comment">//创建设备节点</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IS_ERR</span>(module_device))<br>    &#123;<br>        <span class="hljs-built_in">class_destroy</span>(module_class);<span class="hljs-comment">//删除设备类</span><br>        <span class="hljs-built_in">unregister_chrdev</span>(major_num, DEVICE_NAME);<span class="hljs-comment">//注销字符串设备</span><br>        <span class="hljs-built_in">printk</span>(KERN_INFO <span class="hljs-string">&quot;[r1ng_TestModule:] Failed to create the device!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">PTR_ERR</span>(module_device);<br>    &#125;<br>    <span class="hljs-built_in">printk</span>(KERN_INFO <span class="hljs-string">&quot;[r1ng_TestModule:] Module register complete.\n&quot;</span>);<br><br>    __file = <span class="hljs-built_in">filp_open</span>(DEVICE_PATH, O_RDONLY, <span class="hljs-number">0</span>);<span class="hljs-comment">//filp_open打开的文件</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IS_ERR</span>(__file))<br>    &#123;<br>        <span class="hljs-built_in">device_destroy</span>(module_class, <span class="hljs-built_in">MKDEV</span>(major_num, <span class="hljs-number">0</span>));<br>        <span class="hljs-built_in">class_destroy</span>(module_class);<br>        <span class="hljs-built_in">unregister_chrdev</span>(major_num, DEVICE_NAME);<br>        <span class="hljs-built_in">printk</span>(KERN_INFO <span class="hljs-string">&quot;[r1ng_TestModule:] Unable to change module privilege!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">PTR_ERR</span>(__file);<br>    &#125;<br>    __inode = <span class="hljs-built_in">file_inode</span>(__file);<span class="hljs-comment">//获得file的inode结构体指针</span><br>    __inode-&gt;i_mode |= <span class="hljs-number">0666</span>;<span class="hljs-comment">//修改文件权限</span><br>    <span class="hljs-built_in">filp_close</span>(__file, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-built_in">printk</span>(KERN_INFO <span class="hljs-string">&quot;[arttnba3_TestModule:] Module privilege change complete.\n&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> __exit <span class="hljs-title">kernel_module_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printk</span>(KERN_INFO <span class="hljs-string">&quot;[arttnba3_TestModule:] Start to clean up the module.\n&quot;</span>);<br>    <span class="hljs-built_in">device_destroy</span>(module_class, <span class="hljs-built_in">MKDEV</span>(major_num, <span class="hljs-number">0</span>));<br>    <span class="hljs-built_in">class_destroy</span>(module_class);<br>    <span class="hljs-built_in">unregister_chrdev</span>(major_num, DEVICE_NAME);<br>    <span class="hljs-built_in">printk</span>(KERN_INFO <span class="hljs-string">&quot;[arttnba3_TestModule:] Module clean up complete. See you next time.\n&quot;</span>);<br>&#125;<br><br><span class="hljs-built_in">module_init</span>(kernel_module_init);<br><span class="hljs-built_in">module_exit</span>(kernel_module_exit);<br><span class="hljs-built_in">MODULE_LICENSE</span>(<span class="hljs-string">&quot;GPL&quot;</span>);<br><span class="hljs-built_in">MODULE_AUTHOR</span>(<span class="hljs-string">&quot;r1ng&quot;</span>);<br></code></pre></td></tr></table></figure>

<blockquote>
<p>在这里我们用到了一个函数<code>IS_ERR()</code>，定义于<code>include/linux/err.h</code>中，其核心为宏<code>IS_ERR_VALUE()</code>，即对于内核中的一些操作（如创建设备节点等）若是失败，则通常会返回一个小于<code>-4095</code>的负值，该函数用以进行判定 </p>
</blockquote>
<p>如此便成功注册了一个设备，现在需要为内核模块再编写相应的API，就可以在用户态应用程序上通过虚拟设备完成与内核模块的通信。</p>
<h2 id="（二）编写系统调用接口函数"><a href="#（二）编写系统调用接口函数" class="headerlink" title="（二）编写系统调用接口函数"></a>（二）编写系统调用接口函数</h2><h2 id="（三）测试模块接口"><a href="#（三）测试模块接口" class="headerlink" title="（三）测试模块接口"></a>（三）测试模块接口</h2><p>这部分还不太理解，先缓一缓。</p>
<h2 id="（四）procfs接口"><a href="#（四）procfs接口" class="headerlink" title="（四）procfs接口"></a>（四）procfs接口</h2><p>除了用虚拟节点供于设备通信外，还可以选择创建虚拟文件节点的方式进行内核与用户程序的通信。</p>
<p>procfs即<strong>进程文件系统</strong>，包含一个伪文件系统，在系统启动的时候动态生成文件，不会占用真正的存储，而是占用一定的内存。通过内核进行访问信息，通常被挂载到<code>/proc</code>目录下</p>
<h2 id="六、使用qemu-gdb调试linux内核"><a href="#六、使用qemu-gdb调试linux内核" class="headerlink" title="六、使用qemu+gdb调试linux内核"></a>六、使用qemu+gdb调试linux内核</h2><h2 id="（一）载入内核符号表"><a href="#（一）载入内核符号表" class="headerlink" title="（一）载入内核符号表"></a>（一）载入内核符号表</h2><p>首先是需要载入内核符号表，直接使用gdb载入之前在源码根目录下编译出来的未压缩的内核镜像vmlinux：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo gdb vmlinux</span><br></code></pre></td></tr></table></figure>

<h2 id="（二）remote连接"><a href="#（二）remote连接" class="headerlink" title="（二）remote连接"></a>（二）remote连接</h2><p>启动内核的时候，已经将其映射到了本地的1234端口，直接gdb连接上就可以了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash"><span class="hljs-built_in">set</span> architecture i386:x86-64</span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">target remote localhost:1234</span><br></code></pre></td></tr></table></figure>

<p>如果要用源码调试的话，就肯定是要用我们编译出来的内核。</p>
<h2 id="（三）解压bzImage镜像"><a href="#（三）解压bzImage镜像" class="headerlink" title="（三）解压bzImage镜像"></a>（三）解压bzImage镜像</h2><p>有时候只有压缩过后的镜像bzImage，我们可以用如下的脚本将其解压：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">SPDX-License-Identifier: GPL-2.0-only</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">----------------------------------------------------------------------</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">extract-vmlinux - Extract uncompressed vmlinux from a kernel image</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash"><span class="hljs-comment"># Inspired from extract-ikconfig</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">(c) 2009,2010 Dick Streefland &lt;dick@streefland.net&gt;</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash"><span class="hljs-comment"># (c) 2011      Corentin Chary &lt;corentin.chary@gmail.com&gt;</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash"><span class="hljs-comment"># ----------------------------------------------------------------------</span></span><br><br>check_vmlinux()<br>&#123;<br>    # Use readelf to check if it&#x27;s a valid ELF<br>    # TODO: find a better to way to check that it&#x27;s really vmlinux<br>    #       and not just an elf<br>    readelf -h $1 &gt; /dev/null 2&gt;&amp;1 || return 1<br><br>    cat $1<br>    exit 0<br>&#125;<br><br>try_decompress()<br>&#123;<br>    # The obscure use of the &quot;tr&quot; filter is to work around older versions of<br>    # &quot;grep&quot; that report the byte offset of the line instead of the pattern.<br><br>    # Try to find the header ($1) and decompress from here<br>    for    pos in `tr &quot;$1\n$2&quot; &quot;\n$2=&quot; &lt; &quot;$img&quot; | grep -abo &quot;^$2&quot;`<br>    do<br>        pos=$&#123;pos%%:*&#125;<br>        tail -c+$pos &quot;$img&quot; | $3 &gt; $tmp 2&gt; /dev/null<br>        check_vmlinux $tmp<br>    done<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Check invocation:</span><br>me=$&#123;0##*/&#125;<br>img=$1<br>if    [ $# -ne 1 -o ! -s &quot;$img&quot; ]<br>then<br>    echo &quot;Usage: $me &lt;kernel-image&gt;&quot; &gt;&amp;2<br>    exit 2<br>fi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Prepare temp files:</span><br>tmp=$(mktemp /tmp/vmlinux-XXX)<br>trap &quot;rm -f $tmp&quot; 0<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">That didn<span class="hljs-string">&#x27;t work, so retry after decompression.</span></span><br>try_decompress &#x27;\037\213\010&#x27; xy    gunzip<br>try_decompress &#x27;\3757zXZ\000&#x27; abcde unxz<br>try_decompress &#x27;BZh&#x27;          xy    bunzip2<br>try_decompress &#x27;\135\0\0\0&#x27;   xxx   unlzma<br>try_decompress &#x27;\211\114\132&#x27; xy    &#x27;lzop -d&#x27;<br>try_decompress &#x27;\002!L\030&#x27;   xxx   &#x27;lz4 -d&#x27;<br>try_decompress &#x27;(\265/\375&#x27;   xxx   unzstd<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-string">Finally check for uncompressed images or objects:</span></span><br>check_vmlinux $img<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-string">Bail out:</span></span><br>echo &quot;$me: Cannot find vmlinux.&quot; &gt;&amp;2<br></code></pre></td></tr></table></figure>

<p>用法如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./extract-vmlinux ./bzImage &gt; vmlinux</span><br></code></pre></td></tr></table></figure>

<h2 id="七、ctf中kernel类题目的部署"><a href="#七、ctf中kernel类题目的部署" class="headerlink" title="七、ctf中kernel类题目的部署"></a>七、ctf中kernel类题目的部署</h2><p> 和常规的CTF题目的布置方法是相类似的，最常见的办法便是使用<code>ctf_xinted</code> + <code>docker</code>布置，我们只需要配置<strong>用 ctf_xinetd 启动 boot.sh 即可</strong></p>
<p>大概的框架如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">tree</span><br>.<br>├── ctf.xinetd<br>├── Dockerfile<br>├── bin<br>│   ├── boot.sh<br>│   ├── bzImage<br>│   └── rootfs.cpio<br>├── README.md<br>└── start.sh<br><br>1 directory, 7 files<br></code></pre></td></tr></table></figure>

<p>文件内容大致如下：</p>
<p><strong>Dockerfile：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell">FROM ubuntu:20.04<br><br>RUN sed -i &quot;s/http:\/\/archive.ubuntu.com/http:\/\/mirrors.tuna.tsinghua.edu.cn/g&quot; /etc/apt/sources.list &amp;&amp; \<br>    apt-get update &amp;&amp; apt-get -y dist-upgrade &amp;&amp; \<br>    DEBIAN_FRONTEND=noninteractive \<br>    apt-get install -y lib32z1 xinetd git libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev qemu qemu-system-x86<br><br>RUN useradd -m ctf<br><br>WORKDIR /<br><br>COPY ./ctf.xinetd /etc/xinetd.d/ctf<br>COPY ./start.sh /start.sh<br>RUN echo &quot;Blocked by ctf_xinetd&quot; &gt; /etc/banner_fail<br><br>RUN chmod +x /start.sh<br><br>COPY ./bin/ /<br><br>CMD [&quot;/start.sh&quot;]<br><br>EXPOSE 25000<br></code></pre></td></tr></table></figure>

<p><strong>ctf.xinted:</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell">service ctf<br>&#123;<br>    disable = no<br>    socket_type = stream<br>    protocol    = tcp<br>    wait        = no<br>    user        = ctf<br>    type        = UNLISTED<br>    port        = 25000<br>    bind        = 0.0.0.0<br>    server      = /boot.sh<br>    # replace helloworld to your program<br>    banner_fail = /etc/banner_fail<br>    # safety options<br>    per_source    = 10 # the maximum instances of this service per source IP address<br>    rlimit_cpu    = 20 # the maximum number of CPU seconds that the service may use<br>    #rlimit_as  = 1024M # the Address Space resource limit for the service<br>    #access_times = 2:00-9:00 12:00-24:00<br>&#125;<br></code></pre></td></tr></table></figure>

<p>用如下命令启动xinted：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo docker build -t <span class="hljs-string">&quot;kernel&quot;</span> .</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo docker run -d -p <span class="hljs-string">&quot;0.0.0.0:25000:25000&quot;</span> -h <span class="hljs-string">&quot;kernel&quot;</span> --name=<span class="hljs-string">&quot;kernel&quot;</span> kernel</span><br></code></pre></td></tr></table></figure>

<p><strong>init：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br><br>mount -t proc none /proc<br>mount -t sysfs none /sys<br>mount -t devtmpfs devtmpfs /dev<br><br>exec 0&lt;/dev/console<br>exec 1&gt;/dev/console<br>exec 2&gt;/dev/console<br><br>chown root:root /flag<br>chmod 600 /flag<br><br>insmod a3dev.ko<br><br>echo -e &quot;\nBoot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds\n&quot;<br>setsid cttyhack setuidgid 1000 sh<br><br>umount /proc<br>umount /sys<br>poweroff -d 0  -f<br></code></pre></td></tr></table></figure>

<p><strong>boot.sh：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br>qemu-system-x86_64 \<br>    -m 128M \<br>    -kernel ./bzImage \<br>    -initrd  ./rootfs.cpio \<br>    -append &quot;root=/dev/ram console=ttyS0 oops=panic panic=1 loglevel=3 quiet nokaslr&quot; \<br>    -cpu kvm64,+smep,+smap \<br>    -smp cores=2,threads=2 \<br>    -netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \<br>    -nographic \<br>    -monitor /dev/null<br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/pwn%E5%86%85%E6%A0%B8/" class="category-chain-item">pwn内核</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%AD%A6%E4%B9%A0/">#学习</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>【kernel 1】kernel pwn入门知识</div>
      <div>https://k4n9.cn/2022/12/21/【kernel 1】Kernel PWN入门知识/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Kk</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年12月21日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/09/08/Test/" title="KK的博客启动啦！">
                        <span class="hidden-mobile">KK的博客启动啦！</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

<div>
  <span id="timeDate">载入天数...</span>
  <span id="times">载入时分秒...</span>
  <script>
  var now = new Date();
  function createtime(){
      var grt= new Date("09/08/2022 00:00:00");//此处修改你的建站时间或者网站上线时间
      now.setTime(now.getTime()+250);
      days = (now - grt ) / 1000 / 60 / 60 / 24;
      dnum = Math.floor(days);
      hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum);
      hnum = Math.floor(hours);
      if(String(hnum).length ==1 ){
          hnum = "0" + hnum;
      }
      minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
      mnum = Math.floor(minutes);
      if(String(mnum).length ==1 ){
                mnum = "0" + mnum;
      }
      seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
      snum = Math.round(seconds);
      if(String(snum).length ==1 ){
                snum = "0" + snum;
      }
      document.getElementById("timeDate").innerHTML = "🚀 安全运行&nbsp"+dnum+"&nbspdays";  //此次自定义显示内容
      document.getElementById("times").innerHTML = hnum + "&nbsphr&nbsp" + mnum + "&nbspmin&nbsp" + snum + "&nbspsec";
  }  //此次自定义显示内容
  setInterval("createtime()",250);
  </script>
</div>
  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/love.js"></script>
<!--浏览器搞笑标题-->
<script type="text/javascript" src="/js/FunnyTitle.js"></script>

<!-- 雪花特效 -->
<script type="text/javascript" src="http://libs.baidu.com/jquery/1.8.3/jquery.js"></script>
<script type="text/javascript" src="http://libs.baidu.com/jquery/1.8.3/jquery.min.js"></script>
<script type="text/javascript" src="\js\snow.js"></script>
